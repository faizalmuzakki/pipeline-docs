# 5.1.4 Vendor Management

This component handles all vendor/manufacturer (Mills) operations including vendor list display, creation, editing, approval workflow with status transitions (PENDING → TO_REVIEW → APPROVED/REJECTED), usage validation, and bulk operations.

---

## Component Design Diagram

```mermaid
graph LR
    %% Vendor List Flow
    UI_LIST["&lt;&lt;UI&gt;&gt;<br/>Vendor List"]
    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    MILL_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>MillService"]
    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]

    UI_LIST -->|"Send Token"| SEC1
    SEC1 -.->|"Get vendor list"| MILL_SVC1
    MILL_SVC1 -.->|"Query mills<br/>(filter by status)"| DB1

    %% Create Vendor Flow
    UI_CREATE["&lt;&lt;UI&gt;&gt;<br/>Create Vendor"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    MILL_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>MillService"]
    HIST_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>MillHistoryService"]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]

    UI_CREATE -->|"Send Token"| SEC2
    SEC2 -.->|"Event: Create Vendor"| MILL_SVC2
    MILL_SVC2 -.->|"Check duplicate API"| DB2
    MILL_SVC2 -.->|"Save vendor<br/>(status: PENDING)"| DB2
    MILL_SVC2 -.->|"Create history record"| HIST_SVC1
    HIST_SVC1 -.->|"Save history"| DB2

    %% Edit Vendor Flow
    UI_EDIT["&lt;&lt;UI&gt;&gt;<br/>Edit Vendor"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    MILL_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>MillService"]
    HIST_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>MillHistoryService"]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]

    UI_EDIT -->|"Send Token"| SEC3
    SEC3 -.->|"Event: Update Vendor"| MILL_SVC3
    MILL_SVC3 -.->|"Save proposed changes<br/>(status: TO_REVIEW)"| DB3
    MILL_SVC3 -.->|"Create history record"| HIST_SVC2
    HIST_SVC2 -.->|"Save history"| DB3

    %% Approve Vendor Flow
    UI_APPROVE["&lt;&lt;UI&gt;&gt;<br/>Approve Vendor"]
    SEC4["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    MILL_SVC4["&lt;&lt;Application Service&gt;&gt;<br/>MillService"]
    HIST_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>MillHistoryService"]
    EMAIL_SVC["&lt;&lt;Application Service&gt;&gt;<br/>EmailService"]
    DB4[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]
    EMAIL["&lt;&lt;External&gt;&gt;<br/>Email System"]

    UI_APPROVE -->|"Send Token"| SEC4
    SEC4 -.->|"Event: Approve"| MILL_SVC4
    MILL_SVC4 -.->|"Update status<br/>(APPROVED)"| DB4
    MILL_SVC4 -.->|"Create history record"| HIST_SVC3
    HIST_SVC3 -.->|"Save history"| DB4
    MILL_SVC4 -.->|"Send notification"| EMAIL_SVC
    EMAIL_SVC -.->|"Email to creator"| EMAIL

    %% Reject Vendor Flow
    UI_REJECT["&lt;&lt;UI&gt;&gt;<br/>Reject Vendor"]
    SEC5["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    MILL_SVC5["&lt;&lt;Application Service&gt;&gt;<br/>MillService"]
    SOW_SVC["&lt;&lt;Application Service&gt;&gt;<br/>SOWService"]
    HIST_SVC4["&lt;&lt;Application Service&gt;&gt;<br/>MillHistoryService"]
    DB5[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]
    DB_PROJ[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Project DBs)")]

    UI_REJECT -->|"Send Token"| SEC5
    SEC5 -.->|"Event: Reject"| MILL_SVC5
    MILL_SVC5 -.->|"Check vendor usage"| SOW_SVC
    SOW_SVC -.->|"Query SOWs"| DB_PROJ
    MILL_SVC5 -.->|"Update status<br/>(REJECTED)"| DB5
    MILL_SVC5 -.->|"Clear from SOW forms"| SOW_SVC
    MILL_SVC5 -.->|"Create history record"| HIST_SVC4
    HIST_SVC4 -.->|"Save history"| DB5

    style UI_LIST fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_CREATE fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_EDIT fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_APPROVE fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_REJECT fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC4 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC5 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style MILL_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style MILL_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style MILL_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style MILL_SVC4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style MILL_SVC5 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style HIST_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style HIST_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style HIST_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style HIST_SVC4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style SOW_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB5 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB_PROJ fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL fill:#9E9E9E,color:#fff
```

*Figure: Vendor Management Component Design*

**Vuex Actions**: `global_mill/getMills`, `createMill`, `updateMill`, `deleteMill`, `vendorApproval`

---

## 5.1.4.1 User Interface

### MillComponent.vue (Vendor List)

Displays all vendors with status-based filtering:
- **Status Tabs**: PENDING, APPROVED, REJECTED, TO_REVIEW
- **Columns**: API Number, Name, Short Name, Location, Country, Status badge, Actions
- **Search**: Real-time search across API, name, short name, location
- **Actions** (role-based):
  - **All Users**: View, Edit, History
  - **Vendor Approver**: Approve, Reject, Bulk Approve/Reject

**Status Values** (from Mill model constants):
- **"Pending for Approval"**: Yellow badge - awaiting initial approval
- **"Approved"**: Green badge - active and usable
- **"Rejected"**: Red badge - denied, not usable
- **"To Review"**: Orange badge - has proposed changes awaiting approval

### MillFormComponent.vue (Create/Edit Vendor)

Form for creating or editing vendors:
- **API Number** (required): Unique identifier
- **Name** (required): Full vendor name
- **Short Name** (required): Abbreviated name
- **Location** (required): City/region
- **Country** (required): Country dropdown
- **Additional Info**: Contact details, certifications

**Behavior**:
- **Create**: Saves with `status: "Pending for Approval"` → requires approval
- **Edit Approved Vendor**: Saves proposed changes with `status: "To Review"` → requires re-approval
- **Edit Pending/Rejected**: Direct update without approval

### Approval Panel (Vendor Approver Only)

Visible only to users with `isVendorApprover` flag:
- **Single Approve/Reject**: Buttons on each vendor row
- **Bulk Operations**: Select multiple vendors → Approve All / Reject All
- **Modification Review**: Side-by-side comparison of current vs proposed changes
  - **Agree**: Applies changes, sets status to APPROVED
  - **Deny**: Restores previous data, updates status based on history

---

## 5.1.4.2 Security

### Middleware

**For Vendor List/View**:
- Requires `global.vendor` privilege (R access)
- All authenticated users can view vendors

**For Create/Edit/Delete**:
- Requires `global.vendor` privilege (RW access)
- Any user with write access can create/edit/delete

**For Approve/Reject**:
- Requires `isVendorApprover` flag (special role)
- Only Vendor Approvers can change status
- Blocks regular users even with RW access

---

## 5.1.4.3 Application Services

### MillService (Globals)

**1. Get Vendor List** (`index()` method):
- Queries `mills` collection with status filter
- Returns: api_number, name, short_name, location, country, status
- For TO_REVIEW status: Checks history to show if previously rejected

**2. Create Vendor** (`create()` method):
- Validates API number uniqueness via `checkDuplicate()`
- Saves vendor with `status: "Pending for Approval"`
- Creates history record via MillHistoryService
- Returns vendor ID

**3. Update Vendor** (`update()` method):
- **If status = "Approved"**: Saves proposed changes, sets `status: "To Review"`
- **If status = "Pending for Approval"/"Rejected"**: Direct update
- Creates history record
- Returns success response

**4. Vendor Approval** (`vendorApproval()` method):
Handles all approval operations based on request parameters:
- **Parameters**:
  - `is_reject`: Boolean (true = reject/deny, false = approve/agree)
  - `is_review`: Boolean (true = agree/deny modification, false = approve/reject new vendor)
  - `mill_ids`: Array of vendor IDs for bulk operations
  - `reason`: Rejection/denial reason (required if `is_reject = true`)

- **Approve** (`is_reject=false`, `is_review=false`):
  - Updates `status: "Approved"`
  - Creates history record
  - Sends email notification to creator

- **Reject** (`is_reject=true`, `is_review=false`):
  - Updates `status: "Rejected"`
  - Creates history record with reason
  - Returns success response
  - **Note**: Rejection is allowed even if vendor is in use (unlike deletion)

- **Agree Modification** (`is_reject=false`, `is_review=true`):
  - Applies proposed changes
  - Updates `status: "Approved"`
  - Creates history record

- **Deny Modification** (`is_reject=true`, `is_review=true`):
  - Restores previous approved data
  - Updates status based on history
  - Creates history record with reason

**5. Delete Vendor** (`delete()` method):
- **Usage Check**: Queries all project DBs for vendor usage
- If used: Prevents deletion with error
- If not used: **Hard delete** - permanently removes record
- Returns success response

### MillHistoryService (Globals)

Manages vendor audit trail:
- **Create History**: Records all status changes with user, timestamp, reason
- **Get History**: Retrieves complete timeline for a vendor
- **Format History**: Enriches with user details for display

### SOWService (Project DBs)

**Check Vendor Usage**:
- Queries all project databases for SOW records using the vendor
- Returns list of projects where vendor is referenced
- Used to prevent **deletion** of in-use vendors (rejection is allowed even if vendor is in use)

---

## 5.1.4.4 Database

### MongoDB (Global DB)

**mills** collection:
- `api_no`: Unique API identifier (string)
- `name`: Full vendor name
- `short_name`: Abbreviated name
- `location`: City/region
- `status`: "Pending for Approval", "Approved", "Rejected", "To Review"
- `type`: "Mill", "Bender", "Coater" (vendor type)
- `created_by`, `updated_by`, `deleted_by`: User email references
- `created_at`, `updated_at`, `deleted_at`: Timestamps (SoftDeletes)

**mill_histories** collection (separate table, not embedded):
- `mill_id`: Vendor reference (belongs to Mill)
- `action`: "Created", "Approved", "Modified", "Denied", "Denied Modification", "Agreed Modification"
- `data`: Object with field changes or action details
- `updated_by_id`: User ID who performed action
- `created_at`: Timestamp

**Indexes**: `api_no` (should be unique, but not enforced in model)

### MongoDB (Project DBs)

**sow** collection (in each project):
- `id_manufacturer`: Reference to vendor `_id` in global DB (main manufacturer)
- `id_manufacturer_mother_pipe`: Vendor for mother pipe (optional)
- `id_manufacturer_centre_pipe`: Vendor for centre pipe (optional)
- `id_manufacturer_pup_pipe`: Vendor for pup pipe (optional)

**sow_coating** collection (in each project):
- `id_coater`: Reference to vendor `_id` in global DB (coater type vendor)

**Note**: All these fields are checked before deletion to prevent removing in-use vendors

---

## Code References

**Backend:**
- Controller: `app/Http/Controllers/Api/Globals/MillController.php`
  - `index()` - Get vendor list
  - `dataTables()` - Get vendors with DataTables format
  - `create()` - Create vendor
  - `read()` - Get single vendor
  - `update()` - Update vendor
  - `delete()` - Delete vendor (with usage check)
  - `vendorApproval()` - Handle approve/reject/agree/deny
  - `checkDuplicate()` - Check API number uniqueness
  - `filterByApiSel()` - Filter vendors by API numbers
- Service: `app/Services/Globals/MillService.php`
- Service: `app/Services/Globals/MillHistoryService.php`
- Service: `app/Services/Projects/SOWService.php` (for usage check)
- Repository: `app/Repositories/Globals/Mill/MillRepository.php`
- Request: `app/Http/Requests/Globals/Mill/StoreMillRequest.php`
- Request: `app/Http/Requests/Globals/Mill/VendorApprovalRequest.php`
- Request: `app/Http/Requests/Globals/Mill/CheckDuplicateMillRequest.php`
- Model: `app/Models/Globals/Mill.php` (status constants)
- Model: `app/Models/Globals/MillHistory.php`

**Frontend:**
- Components:
  - `resources/js/components/global/mill/MillComponent.vue` (list)
  - `resources/js/components/global/mill/MillFormComponent.vue` (create/edit)
- Vuex: `resources/js/store/modules/globals/mill/actions.js`
- Route: `/global/vendor` (privilege: `global.vendor`)

**Email:**
- Notification sent when vendor is approved (check EmailService for template)

---

**Status**: ✅ Re-verified against codebase (BE + FE + Approval Workflow)

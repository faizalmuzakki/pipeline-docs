# 5.1.6 Ports & Locodes

This component manages UN/LOCODE port reference data used for transfer tracking, shipment management, and vessel location tracking across all projects.

---

## Component Design Diagram

```mermaid
graph LR
    %% List Ports Flow
    UI_LIST["&lt;&lt;UI&gt;&gt;<br/>Port List"]
    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    LOC_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>LocodeService"]
    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]

    UI_LIST -->|"Send Token"| SEC1
    SEC1 -.->|"Get ports"| LOC_SVC1
    LOC_SVC1 -.->|"Query locodes<br/>(with search)"| DB1

    %% Create Port Flow
    UI_CREATE["&lt;&lt;UI&gt;&gt;<br/>Create Port & Locode"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    LOC_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>LocodeService"]
    EMAIL_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>EmailService"]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]
    EMAIL1["&lt;&lt;External&gt;&gt;<br/>Email System"]

    UI_CREATE -->|"Send Token"| SEC2
    SEC2 -.->|"Event: Create"| LOC_SVC2
    LOC_SVC2 -.->|"Save port record"| DB2
    LOC_SVC2 -.->|"Send notification"| EMAIL_SVC1
    EMAIL_SVC1 -.->|"Email to admins"| EMAIL1

    %% Update Port Flow
    UI_UPDATE["&lt;&lt;UI&gt;&gt;<br/>Edit Port & Locode"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    LOC_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>LocodeService"]
    EMAIL_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>EmailService"]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]
    EMAIL2["&lt;&lt;External&gt;&gt;<br/>Email System"]

    UI_UPDATE -->|"Send Token"| SEC3
    SEC3 -.->|"Event: Update"| LOC_SVC3
    LOC_SVC3 -.->|"Get old data"| DB3
    LOC_SVC3 -.->|"Update port record"| DB3
    LOC_SVC3 -.->|"Send notification<br/>(if changed)"| EMAIL_SVC2
    EMAIL_SVC2 -.->|"Email to admins"| EMAIL2

    %% Delete Port Flow
    UI_DELETE["&lt;&lt;UI&gt;&gt;<br/>Delete Port & Locode"]
    SEC4["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    LOC_SVC4["&lt;&lt;Application Service&gt;&gt;<br/>LocodeService"]
    TR_REPO["&lt;&lt;Repository&gt;&gt;<br/>TransferRouteRepository"]
    EMAIL_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>EmailService"]
    DB4[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Global DB)")]
    DB_PROJ[("&lt;&lt;Database&gt;&gt;<br/>MongoDB<br/>(Project DBs)")]
    EMAIL3["&lt;&lt;External&gt;&gt;<br/>Email System"]

    UI_DELETE -->|"Send Token"| SEC4
    SEC4 -.->|"Event: Delete"| LOC_SVC4
    LOC_SVC4 -.->|"Check usage"| TR_REPO
    TR_REPO -.->|"Query transfer_routes<br/>(point_loading/<br/>point_discharge)"| DB_PROJ
    LOC_SVC4 -.->|"Hard delete<br/>(if not used)"| DB4
    LOC_SVC4 -.->|"Send notification"| EMAIL_SVC3
    EMAIL_SVC3 -.->|"Email to admins"| EMAIL3

    style UI_LIST fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_CREATE fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_UPDATE fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_DELETE fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC4 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style LOC_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LOC_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LOC_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LOC_SVC4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TR_REPO fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB_PROJ fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style EMAIL1 fill:#9E9E9E,color:#fff
    style EMAIL2 fill:#9E9E9E,color:#fff
    style EMAIL3 fill:#9E9E9E,color:#fff
```

*Figure: Ports & Locodes Component Design*

**Route**: `/global/locodes`

---

## 5.1.6.1 User Interface

### LocodeComponent.vue (Port List)

Searchable data table for UN/LOCODE port reference data:
- **Columns**: LOCODE, Port Name, Country, Subdivision, Coordinates, Functions
- **Search**: Real-time search across LOCODE, name, country
- **Actions**: Create, View, Edit, Delete (all available)
- **Features**: Map visualization of port locations
- **Privilege**: `global.locode` (R for view, RW for create/edit/delete)

---

## 5.1.6.2 Security

### Middleware

- **Authentication**: Verifies JWT token
- **Authorization**:
  - Read: `global.locode:R` (all authenticated users)
  - Write: `global.locode:W` (Super Admin, authorized users only)

---

## 5.1.6.3 Application Services

### LocodeService (Globals)

Manages UN/LOCODE port reference data:

**1. Get Ports** (`index()` / `dataTables()` method):
- Retrieves port list with search, filtering, and pagination
- Returns: locode, name, country_code, country_name, subdivision, latitude, longitude, function

**2. Search Ports** (`search()` method):
- Provides autocomplete search for port selection
- Used in transfer forms across projects
- Returns: id, desc (locode + name), locode, name

**3. Create Port** (`create()` method):
- Generates LOCODE: `country_code + " " + UPPERCASE(code)`
- Saves port record with country info
- **Email Notification**: If `GLOBAL_CHANGE_NOTIFICATION=true`:
  - Sends email to admins (from `GLOBAL_CHANGE_EMAIL` env)
  - Email includes: created by user, country, locode, port name
- Returns success response with ID

**4. Read Port** (`read()` method):
- Retrieves port details by ID
- Transforms data: extracts code from locode, renames fields
- Returns: country (object), code, port, subdivision, etc.

**5. Update Port** (`update()` method):
- Gets old port data for comparison
- Updates port information (name, coordinates, country, etc.)
- **Email Notification**: If `GLOBAL_CHANGE_NOTIFICATION=true`:
  - Compares old vs new data using `checkUpdateInfo()`
  - If changed: Sends email to admins
  - Email includes: updated by user, port & locode, old vs new values
- Returns success response

**6. Delete Port** (`delete()` method):
- **Usage Check**: Queries all project DBs for transfer routes
  - Checks `transfer_routes` collection for `point_loading` or `point_discharge` references
  - If used: Returns error status
- **Hard Delete**: Permanently removes record if not used
- **Email Notification**: If `GLOBAL_CHANGE_NOTIFICATION=true`:
  - Sends email to admins
  - Email includes: deleted by user, country, locode, port name
- Returns success response

**7. Get Port or Fallback** (`getPortOrFallback()` method):
- Helper method to get port name by ID
- Returns port name or original value if not found

### TransferRouteRepository (Project DBs)

Used for usage check:
- Queries `transfer_routes` collection across all project databases
- Checks if locode is referenced in transfer records

---

## 5.1.6.4 Database

### MongoDB (Global DB)

**locode** collection (UN/LOCODE port data):
- `country_code`: ISO 3166-1 alpha-2 (e.g., "SG", "US", "ID")
- `country_name`: Full country name
- `locode`: UN/LOCODE code (e.g., "SG SIN", "US HOU", "ID CGK")
- `name`: Port name
- `sub_div`: State/province code
- `created_by`, `updated_by`: User emails
- `created_at`, `updated_at`: Timestamps

---

## Code References

**Backend:**
- Controller: `app/Http/Controllers/Api/Globals/LocodeController.php`
  - `index()` - Get port list
  - `dataTables()` - Get ports with DataTables format
  - `read()` - Get single port
  - `update()` - Update port
  - `search()` - Autocomplete search
- Service: `app/Services/Globals/LocodeService.php`
- Repository: `app/Repositories/Globals/Locode/LocodeRepository.php`
- Request: `app/Http/Requests/Globals/Locode/StoreLocodeRequest.php`

**Frontend:**
- Component: `resources/js/components/global/locode/LocodeComponent.vue`
- Vuex: `resources/js/store/modules/globals/locode/actions.js`
- Route: `/global/locodes` (privilege: `global.locode`)

---

**Status**: âœ… Consolidated from separate files

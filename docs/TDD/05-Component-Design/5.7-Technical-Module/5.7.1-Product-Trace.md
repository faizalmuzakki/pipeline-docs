# 5.7.1 Product Trace

The Product Trace component provides complete material traceability from production through delivery. Users can track individual pipes by heat number, pipe number, and view comprehensive inspection results, transfer history, and length history for quality control and traceability reporting.

```mermaid
graph LR
    UI_LIST["&laquo;UI&raquo;<br/>Product Trace List"]
    UI_DETAIL["&laquo;UI&raquo;<br/>Product Trace Detail"]
    UI_TALLY["&laquo;UI&raquo;<br/>Tally List"]
    UI_TRANSFER["&laquo;UI&raquo;<br/>Transfer"]
    UI_INSPECTION["&laquo;UI&raquo;<br/>Inspection"]

    SEC1["&laquo;Security&raquo;<br/>Middleware"]
    SEC2["&laquo;Security&raquo;<br/>Middleware"]
    SEC3["&laquo;Security&raquo;<br/>Middleware"]
    SEC4["&laquo;Security&raquo;<br/>Middleware"]
    SEC5["&laquo;Security&raquo;<br/>Middleware"]

    PT_SVC1["&laquo;Application Service&raquo;<br/>ProductTraceService"]
    PT_SVC2["&laquo;Application Service&raquo;<br/>ProductTraceService"]
    TALLY_SVC["&laquo;Application Service&raquo;<br/>TallyListService"]
    PT_SVC3["&laquo;Application Service&raquo;<br/>ProductTraceService"]
    TRANSFER_SVC["&laquo;Application Service&raquo;<br/>TransferService"]
    PT_SVC4["&laquo;Application Service&raquo;<br/>ProductTraceService"]
    INSP_SVC["&laquo;Application Service&raquo;<br/>InspectionService"]
    PT_SVC5["&laquo;Application Service&raquo;<br/>ProductTraceService"]

    DB1[("&laquo;Database&raquo;<br/>MongoDB")]
    DB2[("&laquo;Database&raquo;<br/>MongoDB")]
    DB3[("&laquo;Database&raquo;<br/>MongoDB")]
    DB4[("&laquo;Database&raquo;<br/>MongoDB")]
    DB5[("&laquo;Database&raquo;<br/>MongoDB")]

    %% Product Trace List Flow
    UI_LIST -->|Request product trace list| SEC1
    SEC1 -.->|Get product trace data| PT_SVC1
    PT_SVC1 -.->|Query tally_list & related data| DB1

    %% Product Trace Detail Flow
    UI_DETAIL -->|Request trace detail| SEC2
    SEC2 -.->|Get trace detail| PT_SVC2
    PT_SVC2 -.->|Query pipe details,<br/>inspection, transfer, length history| DB2

    %% Tally List Trigger Flow
    UI_TALLY -.->|Upload/Edit/Delete tally| SEC3
    SEC3 -.->|Save tally data| TALLY_SVC
    TALLY_SVC -.->|Update tally_list| DB3
    TALLY_SVC -.->|Trigger regeneration| PT_SVC3
    PT_SVC3 -.->|Regenerate product trace| DB3

    %% Transfer Trigger Flow
    UI_TRANSFER -.->|Create/Update/Delete transfer| SEC4
    SEC4 -.->|Save transfer data| TRANSFER_SVC
    TRANSFER_SVC -.->|Update transfer| DB4
    TRANSFER_SVC -.->|Trigger regeneration| PT_SVC4
    PT_SVC4 -.->|Regenerate product trace| DB4

    %% Inspection Trigger Flow
    UI_INSPECTION -.->|Upload/Delete inspection| SEC5
    SEC5 -.->|Save inspection data| INSP_SVC
    INSP_SVC -.->|Update test_table| DB5
    INSP_SVC -.->|Trigger regeneration| PT_SVC5
    PT_SVC5 -.->|Regenerate product trace| DB5

    style UI_LIST fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_DETAIL fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_TALLY fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_TRANSFER fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_INSPECTION fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC4 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC5 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style PT_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style PT_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style PT_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style PT_SVC4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style PT_SVC5 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TALLY_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TRANSFER_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style INSP_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB5 fill:#4FB3BF,stroke:#2a6d76,color:#fff
```

## 5.7.1.1 User Interface

### 5.7.1.1.1 Product Trace List

This is the entry point for viewing all product trace records. Users can view pipe numbers, heat numbers, item descriptions, lengths, pipe status, related SOWs, locations, and issues. The list provides DataTables with server-side processing for pagination, sorting, and filtering. Users can filter by item description, pipe status, SOW, location, issue, and item type. Upon page load, it sends authentication token and retrieves product trace data.

### 5.7.1.1.2 Product Trace Detail

This UI displays comprehensive traceability information for a selected pipe. Users can view pipe details, manufacturing inspection results, coating inspection results, transfer history, length history, and remarks. Each section provides detailed DataTables with sorting capabilities. The entire detail page can be exported to PDF including all available tabs (manufacturing inspection, coating inspection, transfer history, length history, and remarks). The detail view shows complete genealogy from SOW through work orders to final delivery.

### 5.7.1.1.3 Tally List (Trigger)

This trigger is from Work Order detail coating progress and Lenght History page. Users can upload tally files, view tally data, edit remarks, and delete tally records. The system automatically regenerates product trace data when tally records are created, updated, or deleted to maintain synchronized traceability information.

### 5.7.1.1.4 Transfer (Trigger)

This UI from the Transfer module triggers product trace regeneration when users create, update, or delete transfer tally records. The system automatically regenerates product trace data for all pipes in the transfer to update location and movement history.

### 5.7.1.1.5 Inspection (Trigger)

This UI from the Inspection module triggers product trace regeneration when users upload or delete inspection test results. The system automatically regenerates product trace data for all pipes in the work order to update inspection status and test results.

## 5.7.1.2 Security

Middleware validates the authentication token sent from Product Trace UIs. Only authenticated and authorized users can proceed to view product trace data.

**Security Checks:**
- `auth:api` - Validates JWT token via Laravel Passport
- `project.session:api` - Validates user has access to the project database
- `work_order:R` - Required to view product trace data

## 5.7.1.3 Application Services

### 5.7.1.3.1 Initial Data Retrieval

- **Product Trace Service**: Retrieves product trace list data from tally_list collection with related work order, SOW, transfer, and inspection information.
- **Item Service**: Fetches item master data for product trace display.
- **Specification Service**: Provides specification details for product trace context.
- **Mill Service**: Retrieves manufacturer/coater information for filtering.

### 5.7.1.3.2 Product Trace Data Generation

Generates product trace records from coating tally, transfer tally, and inspection data. Links pipes to work orders, SOWs, transfers, and inspection results. Updates product trace collection with comprehensive traceability information including pipe status, location, and condition.

**Product Trace Regeneration Triggers:**

The system automatically regenerates product trace data whenever pipe data changes through the `product_trace:update` command (dispatched as background job):

- **Regenerate**: Full regeneration of all product trace data for a project.
- **Single Tally**: Regenerates product trace for a single tally list record when created or updated.
- **Transfer Tally**: Regenerates product trace for all tally records linked to a transfer when transfer is created, updated, or deleted.
- **Inspection WO**: Regenerates product trace for all tally records linked to a work order when inspection data is uploaded or updated.
- **Deletion Tally**: Regenerates product trace when tally list records are deleted.
- **Deletion Inspection**: Regenerates product trace when inspection records are deleted.

These triggers ensure product trace data is always synchronized with the latest tally, transfer, and inspection data.

### 5.7.1.3.3 Product Trace Display Operations

The Product Trace Service provides the following operations for querying and displaying traceability data:

- **DataTables**: Retrieves product trace list with server-side pagination, sorting, and filtering.
- **Read**: Retrieves detailed product trace information for a specific pipe by pipe number and heat number.
- **Transfer History DataTable**: Retrieves transfer history for pipes with transfer details and locations.
- **Length History DataTable**: Retrieves length history for pipes with heat numbers and pipe numbers.
- **Manufacturing Inspection DataTable**: Retrieves manufacturing inspection results with test data.
- **Coating Inspection DataTable**: Retrieves coating inspection results with coating specifications.
- **Remarks DataTable**: Retrieves remarks and comments for pipes.
- **Export PDF**: Generates PDF export of product trace data including all tabs.

## 5.7.1.4 Database

MongoDB serves as the central data store for Product Trace. The component interacts with the following collections:

**Project Database (`{mongodb_project}_{project_code}`):**

- **`tally_list`** - Main product trace records. Key fields: _id, pipe_no, mill_pipe_no, heat_no, length, id_wo, id_item, id_spec_manufacturing, pipe_status, location, condition, remark.

- **`work_order`** - Work order records referenced by product trace.

- **`sow`** - SOW records linked to product trace for traceability.

- **`length_history`** - Cutting/length history records for pipes.

- **`transfer_cargo`** - Transfer cargo records for tracking pipe movements.

- **`transfer`** - Transfer records for shipment tracking.

- **`test_table`** - Inspection test results linked to pipes.

- **`material_test`** - Material test results for quality assurance.

- **`product_trace`** - Generated product trace summary records.

- **`item`** - Item master data referenced by product trace.

- **`specification`** - Specification master data referenced by product trace.

**Global Database (`mongodb_global`):**

- **`mill`** - Manufacturer/coater data for filtering product trace by vendor.

All query operations on product trace are handled through the Product Trace Service, ensuring consistent data access patterns and proper multi-tenant database routing.

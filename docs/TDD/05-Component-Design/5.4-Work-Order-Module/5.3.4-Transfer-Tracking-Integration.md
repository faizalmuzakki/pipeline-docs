# 5.3.4 Transfer Tracking Integration

This component handles the automatic initialization of transfer tracking records when work orders are generated, linking the Work Order module to the Transfer & Logistics module for end-to-end material traceability from production through shipment.

---

## Component Design Diagram

```mermaid
graph TB
    subgraph Trigger["Trigger Event"]
        A[Work Order<br/>Generation]
    end
    
    subgraph ApplicationServices["Application Services"]
        B[Work Order Service]
        C[Transfer Track Service]
        D[Transfer Move Service]
        E[SOW Service]
    end
    
    subgraph Database["Database Layer"]
        F[(Project DB:<br/>mongodb_project_X)]
    end
    
    A -->|WO created<br/>from SOW| B
    B -.Get SOW quantities.-> E
    E -.Query sow.-> F
    B -.Call genTransferTrackInfo().-> C
    C -.Get WO items & quantities.-> B
    B -.Query work_order.-> F
    C -.Create transfer_track records.-> F
    C -.Set initial location = manufacturer.-> C
    C -.Set qty_available = WO qty.-> C
    C -.Trigger transfer move init.-> D
    D -.Create transfer_move records.-> F
    D -.Set stage = "production".-> D
    D -.Set from_location = manufacturer.-> D
    D -.Set to_location = null (pending).-> D
    D -.Set qty = WO qty.-> D
    D -.Link to transfer_track.-> F
    
    style Trigger fill:#ffebee
    style ApplicationServices fill:#f3e5f5
    style Database fill:#e8f5e9
```

*Figure: Transfer Tracking Integration Component Design*

---

## 5.3.4.1 User Interface

This component operates entirely in the background with no direct user interface. Transfer tracking initialization is triggered automatically when work orders are generated from SOW completion. Users interact with the results through the Transfer & Logistics module (5.7), where they can view and manage transfer tracking records created by this integration.

---

## 5.3.4.2 Security

No direct security layer for this component as it operates as a background process triggered by work order generation. Security is inherited from the Work Order Generation process (5.3.1), which requires `SCOPE_OF_WORK:RW` privilege to complete SOWs and trigger WO generation.

---

## 5.3.4.3 Application Services

### 5.3.4.3.1 Transfer Tracking Initialization

**Triggered by**: Work Order Generation (automatic)

**Process** (`WorkOrderService::genTransferTrackInfo()` called during `genWorkOrder()`):

1. **Retrieve Work Order Data**: Gets newly created work order with item ID, specification ID, manufacturer ID, quantities (qty_pcs, qty_m, qty_mt).

2. **Retrieve SOW Data**: Fetches parent SOW to get delivery tolerance, delivery terms, and destination information.

3. **Create Transfer Track Records**:
   - For each item in the work order (typically one item per WO):
     - Generates unique _id for transfer_track record
     - Sets `id_wo` reference to work order
     - Sets `id_item` reference to item
     - Sets `id_spec` reference to specification
     - Sets `location` to manufacturer location (initial location)
     - Sets `qty_available` to work order quantity (qty_pcs, qty_m, or qty_mt depending on unit)
     - Sets `stage` to "production" (initial stage)
     - Sets `status` to "In Production"
     - Sets `created_at` timestamp
     - Sets `created_by` to system user (auto-generated)
     - Stores in `transfer_track` collection

4. **Initialize Transfer Moves**: Calls `genTransferMoveInfo()` to create initial transfer move records.

5. **Return Transfer Track IDs**: Returns array of created transfer_track IDs for reference.

### 5.3.4.3.2 Transfer Move Initialization

**Process** (`WorkOrderService::genTransferMoveInfo()` called by `genTransferTrackInfo()`):

1. **Retrieve Transfer Track Data**: Gets newly created transfer_track records with item, quantities, and current location.

2. **Create Initial Transfer Move Records**:
   - For each transfer_track record:
     - Generates unique _id for transfer_move record
     - Sets `id_transfer_track` reference to transfer_track
     - Sets `id_wo` reference to work order
     - Sets `stage` to "production" (initial stage)
     - Sets `from_location` to manufacturer location
     - Sets `to_location` to null (pending - will be set when transfer is created)
     - Sets `qty` to work order quantity
     - Sets `move_type` to "production_allocation"
     - Sets `status` to "Allocated"
     - Sets `created_at` timestamp
     - Sets `created_by` to system user (auto-generated)
     - Stores in `transfer_move` collection

3. **Link to Transfer Track**: Updates transfer_track record with reference to initial transfer_move.

4. **Return Transfer Move IDs**: Returns array of created transfer_move IDs for reference.

### 5.3.4.3.3 Transfer Tracking Update (Future State)

When production is completed and items are ready for shipment, the Transfer & Logistics module (5.7) will:

1. **Update Transfer Track Location**: Changes location from manufacturer to transit/destination
2. **Update Transfer Track Stage**: Changes stage from "production" to "coating" (if applicable) or "shipment"
3. **Create New Transfer Move**: Creates new transfer_move record for the shipment with from_location, to_location, qty, and shipment details
4. **Update Quantity Available**: Reduces qty_available in transfer_track as items are shipped

This enables end-to-end material flow tracking: **Production → Coating → Shipment → Delivery**

---

## 5.3.4.4 Database

MongoDB serves as the central data store for Transfer Tracking Integration. The component interacts with the following collections:

**Project Database (`mongodb_project_{project_code}`):**

- **`transfer_track`** - Transfer tracking master records initialized during WO generation. Key fields: _id, id_wo (reference to work_order._id), id_item (reference to item._id from global DB), id_spec (reference to specification._id from global DB), location (current location, initially manufacturer location), qty_available (quantity available for transfer, initially = WO qty), stage ("production" → "coating" → "shipment" → "delivered"), status ("In Production" → "Ready for Shipment" → "In Transit" → "Delivered"), created_at (timestamp), created_by (user ID or system).

- **`transfer_move`** - Transfer movement records tracking material flow. Key fields: _id, id_transfer_track (reference to transfer_track._id), id_wo (reference to work_order._id), stage (production/coating/shipment), from_location (origin location), to_location (destination location, null initially), qty (quantity being moved), move_type ("production_allocation" → "coating_transfer" → "shipment_transfer"), status ("Allocated" → "In Transit" → "Delivered"), created_at (timestamp), created_by (user ID or system).

- **`work_order`** - Work order records that trigger transfer tracking initialization. Key fields: _id, id_sow, id_manufacturer (used for initial location), qty_pcs/qty_m/qty_mt (used for qty_available).

- **`sow`** - SOW records providing delivery tolerance and destination information. Key fields: _id, delivery_tolerance (object with plus/minus values), delivery_term (Incoterm: DDP/CIF/FOB).

All create and update operations on transfer tracking are handled through the Transfer Track Service and Transfer Move Service, ensuring consistent data access patterns and proper multi-tenant database routing.

---

## Integration Points

### Upstream Integration
- **Work Order Generation (5.3.1)**: Triggers transfer tracking initialization when WO is created from SOW completion
- **SOW Management (5.2)**: Provides delivery tolerance and destination information for transfer tracking

### Downstream Integration
- **Transfer & Logistics (5.7)**: Uses transfer_track and transfer_move records for shipment management, location tracking, and delivery coordination
- **Progress Tracking (5.11)**: Transfer tracking data feeds into overall project progress (shipment progress)

### Lateral Integration
- **Inspection (5.5)**: Transfer tracking links to inspection results for quality assurance before shipment
- **Invoice (5.8)**: Transfer tracking provides shipment data for invoice generation

---

## Business Rules

1. **Automatic Initialization**: Transfer tracking is automatically initialized when work order is generated (no manual creation required)
2. **Initial Location**: Set to manufacturer location from work order
3. **Initial Stage**: Always "production"
4. **Initial Status**: "In Production"
5. **Quantity Allocation**: qty_available initially equals work order quantity
6. **One-to-One Relationship**: One transfer_track record per work order item
7. **Transfer Move Chain**: Transfer moves form a chain tracking material flow from production through delivery
8. **Stage Progression**: production → coating (if applicable) → shipment → delivered
9. **Quantity Validation**: Total transfer move quantities cannot exceed transfer_track qty_available
10. **System User**: Transfer tracking initialization is performed by system user (auto-generated), not manual user

---

## Transfer Tracking Flow

```
SOW Completed
  ↓
Work Order Generated
  ↓
Transfer Track Initialized
  - Location: Manufacturer
  - Stage: Production
  - Qty Available: WO Quantity
  ↓
Transfer Move Created
  - From: Manufacturer
  - To: (Pending)
  - Type: Production Allocation
  ↓
[Production Completed]
  ↓
Transfer Move Updated
  - To: Coating Facility (if applicable)
  - Type: Coating Transfer
  ↓
[Coating Completed]
  ↓
Transfer Move Updated
  - To: Port/Destination
  - Type: Shipment Transfer
  ↓
[Shipment Delivered]
  ↓
Transfer Track Updated
  - Stage: Delivered
  - Status: Delivered
```

---

## Access Control

Transfer tracking initialization is a system process with no direct user access control. Access control is inherited from:

- **Work Order Generation**: Requires `SCOPE_OF_WORK:RW` to complete SOW and trigger WO generation
- **Transfer Management**: Requires `TRANSFER:RW` to view and manage transfer tracking records (see 5.7 Transfer Module)

---

## Related Sections

- **[7.9 Work Order Management DFD](../../07-Data-Flow-Diagrams.md#79-work-order-management)** - Process 3: Initialize Transfer Tracking
- **[5.3.1 Work Order Generation](5.3.1-Work-Order-Generation-Vendor-Tabs.md)** - Upstream: WO generation triggers transfer tracking initialization
- **[5.7 Transfer & Logistics](../5.7-Transfer-Module.md)** - Downstream: Uses transfer tracking records for shipment management
- **[5.2 SOW Management](../5.2-SOW-Module.md)** - Upstream: Provides delivery information for transfer tracking

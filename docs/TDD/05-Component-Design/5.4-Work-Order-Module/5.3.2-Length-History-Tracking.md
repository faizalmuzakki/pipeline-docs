# 5.3.2 Length History Tracking

This component provides detailed production tracking by recording individual pipe lengths, heat numbers, pipe numbers, and photo attachments for quality documentation. It enables real-time progress calculation and complete material traceability for quality assurance.

---

## Component Design Diagram

```mermaid
graph LR
    UI_FORM["&lt;&lt;UI&gt;&gt;<br/>Length History Form"]
    UI_LIST["&lt;&lt;UI&gt;&gt;<br/>Length History List"]
    UI_PHOTO["&lt;&lt;UI&gt;&gt;<br/>Photo Upload"]
    UI_TALLY["&lt;&lt;UI&gt;&gt;<br/>Tally Upload"]

    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC4["&lt;&lt;Security&gt;&gt;<br/>Middleware"]

    LH_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>LengthHistoryService"]
    WO_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>WorkOrderService"]
    FILE_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>FileStorageService"]
    LH_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>LengthHistoryService"]
    LH_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>LengthHistoryService"]
    FILE_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>FileStorageService"]
    TALLY_SVC["&lt;&lt;Application Service&gt;&gt;<br/>TallyListService"]
    LH_SVC4["&lt;&lt;Application Service&gt;&gt;<br/>LengthHistoryService"]

    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB4[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    STORAGE1[("&lt;&lt;File Storage&gt;&gt;<br/>S3/Local")]
    STORAGE2[("&lt;&lt;File Storage&gt;&gt;<br/>S3/Local")]
    STORAGE3[("&lt;&lt;File Storage&gt;&gt;<br/>S3/Local")]

    %% Submit Length Record Flow
    UI_FORM -->|Submit length record| SEC1
    SEC1 -.->|Validate & submit| LH_SVC1
    LH_SVC1 -.->|Create length_history| DB1
    LH_SVC1 -.->|Upload photos| FILE_SVC1
    FILE_SVC1 -.->|Store photos| STORAGE1
    LH_SVC1 -.->|Update WO progress| WO_SVC1
    WO_SVC1 -.->|Update work_order| DB2

    %% Request Length History List Flow
    UI_LIST -->|Request length history| SEC2
    SEC2 -.->|Get length history| LH_SVC2
    LH_SVC2 -.->|Query by manufacturer| DB3

    %% Upload Photos Flow
    UI_PHOTO -->|Upload photos| SEC3
    SEC3 -.->|Upload files| LH_SVC3
    LH_SVC3 -.->|Store files| FILE_SVC2
    FILE_SVC2 -.->|Save to storage| STORAGE2
    LH_SVC3 -.->|Update photos array| DB3

    %% Tally Import Flow (Auto-generate Length History)
    UI_TALLY -->|Import tally file| SEC4
    SEC4 -.->|Process tally import| TALLY_SVC
    TALLY_SVC -.->|Parse Excel & save tally_list| DB4
    TALLY_SVC -.->|Store tally file| STORAGE3
    TALLY_SVC -.->|Generate length history| LH_SVC4
    LH_SVC4 -.->|Bulk create length_history from tally| DB4

    style UI_FORM fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_LIST fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_PHOTO fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_TALLY fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC4 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style LH_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LH_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LH_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LH_SVC4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style WO_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style FILE_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style FILE_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TALLY_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style STORAGE1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style STORAGE2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style STORAGE3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
```

*Figure: Length History Tracking Component Design*

---

## 5.3.2.1 User Interface

### 5.3.2.1.1 Length History Form

This is the entry point for submitting coating production length records. Users enter heat number, pipe number, and length. The form provides dropdown options for item/spec combinations, heat numbers, pipe numbers, and length values. Upon submission, it sends authentication token and length data.

### 5.3.2.1.2 Length History List

This UI displays all length history records for a specific manufacturer. Users can view heat numbers, pipe numbers, lengths, and associated photos. Users can filter by manufacturer and view report files.

### 5.3.2.1.3 View Reports Modal (DataTables)

This UI is a modal that provides a paginated view of all length history records with server-side DataTables processing. Users can view Date Submitted, Item, Heat No., Pipe No., Length, and Report File Name. Users can download report files and delete individual length history records. The modal is accessed via the "View Length Reports" button in the Length History component.

---

## 5.3.2.2 Security

Middleware validates the authentication token sent from Length History UIs. Only authenticated and authorized users can proceed to submit or view length history records.

**Security Checks:**
- `auth:api` - Validates JWT token via Laravel Passport
- `project.session:api` - Validates user has access to the project database
- `work_order:RW` - Required to submit and manage length history records
- `work_order:R` - Required to view length history records

---

## 5.3.2.3 Application Services

### 5.3.2.3.1 Initial Data Retrieval

- **Item Service**: Fetches item options for length history form.
- **Specification Service**: Provides specification options.
- **Length History Service**: Retrieves heat number, pipe number, and length options based on selected item/spec.

### 5.3.2.3.2 Length History Submission

Handles length history record creation and saves it to MongoDB. This includes heat number, pipe number, length, and optional photo attachments.

### 5.3.2.3.3 Auto-Generation from Tally Import

When a production tally file is imported through the Tally Upload UI:

1. **TallyListService** processes the Excel file and saves tally records to `tally_list` collection
2. **TallyListService** calls `LengthHistoryService.genLengthHistory()` to automatically generate length history records
3. **LengthHistoryService** iterates through all tally records and creates corresponding `length_history` records with:
   - Manufacturer, item, and spec from work order
   - Pipe number and heat number from tally
   - Length from tally
   - Initial status as "unresolved"
   - Reference to tally file ID

This auto-generation ensures that all production tally data is immediately available in length history for tracking and reporting.

### 5.3.2.3.4 Length History Operations

Each of the following services handles a specific operation in the length history flow. All of them update length history data in MongoDB through the Length History Service:

- **Add Report**: Creates new length history record with heat number, pipe number, and length.
- **View Length History**: Retrieves length history records filtered by manufacturer.
- **Report DataTables**: Handles server-side DataTables processing for length history list.
- **Delete Report**: Removes length history records.
- **Delete Item from Report**: Removes specific items from report.
- **Download History Photos**: Downloads attached photos from storage.
- **Resolve Length History**: Resolves and processes length history data.
- **Generate Length History**: Bulk creates length history records from tally list data.

---

## 5.3.2.4 Database

MongoDB serves as the central data store for Length History Tracking. The component interacts with the following collections:

**Project Database (`{mongodb_project}_{project_code}`):**

- **`length_history`** - Individual pipe length records. Key fields: _id, id_wo, id_manufacturer, id_item, id_spec_manufacturing, qty_unit, heat_no, pipe_no, length, photos (array), report_file_name, created_at, created_by.

- **`work_order`** - Work order records referenced by length history.

- **`tally_list`** - Tally list records used for generating length history.

**Global Database (`mongodb_global`):**

- **`item`** - Item master data referenced by length history.

- **`specification`** - Specification master data referenced by length history.

- **`mill`** - Manufacturer/coater data for filtering length history by vendor.

**File Storage (`S3 / Local`):**

- **Length History Photos**: Stored with file paths saved in length_history.photos array.

All create, update, and fetch operations on length history are handled through the Length History Service, ensuring consistent data access patterns and proper multi-tenant database routing.

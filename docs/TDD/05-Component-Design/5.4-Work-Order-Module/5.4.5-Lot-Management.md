# 5.4.5 Lot Management

This component manages production lots for work orders, enabling lot-based tracking for manufacturing, coating, inspection, and delivery processes. Each lot represents a batch of items with specific quantities and schedules.

---

## Component Design Diagram

```mermaid
graph LR
    UI_ADD["&lt;&lt;UI&gt;&gt;<br/>Add Lot Form"]
    UI_MODIFY["&lt;&lt;UI&gt;&gt;<br/>Modify Lot Form"]
    UI_LIST["&lt;&lt;UI&gt;&gt;<br/>Lot List View"]

    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]

    WO_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>WorkOrderController"]
    WO_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>WorkOrderController"]
    WO_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>WorkOrderController"]

    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB Project")]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB Project")]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB Project")]

    %% Add Lot Flow
    UI_ADD -->|Submit lot data| SEC1
    SEC1 -.->|Create lot| WO_SVC1
    WO_SVC1 -.->|Save to work_order_lot &<br/>work_order_schedule| DB1

    %% Modify Lot Flow
    UI_MODIFY -->|Update lot data| SEC2
    SEC2 -.->|Update lot| WO_SVC2
    WO_SVC2 -.->|Update work_order_lot &<br/>work_order_schedule| DB2

    %% View Lot Flow
    UI_LIST -->|Request lots| SEC3
    SEC3 -.->|Query lots| WO_SVC3
    WO_SVC3 -.->|Fetch work_order_lot| DB3

    style UI_ADD fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_MODIFY fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style UI_LIST fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style WO_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style WO_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style WO_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
```

*Figure: Lot Management Component Design*

---

## 5.4.5.1 User Interface

### 5.4.5.1.1 Add Lot Form

Form for creating new lots with quantity and schedule information. Different forms for different processes:
- **Production**: ProductionAddLotFormComponent
- **Coating**: CoatingAddLotFormComponent
- **Document Submission**: DocSubmissionLotFormComponent

### 5.4.5.1.2 Modify Lot Form

Form for updating existing lot quantities and schedules. Separate modify forms for each process type matching the add forms.

### 5.4.5.1.3 Lot List View

Displays all lots for a work order with quantities, schedules, and progress. Shows lot-based progress tracking and allows lot management operations.

---

## 5.4.5.2 Security

**Write Operations** (`project.wo:W`):
- Create lot: `createLot()`
- Delete lot: `deleteLot()`

**Read Operations** (`project.wo:R`):
- View lot list: `lotFilterWO()`, `lotFilterSOW()`
- Get lot options for dropdowns

---

## 5.4.5.3 Application Services

### 5.4.5.3.1 Create/Update Lot

`WorkOrderController::createLot()` - Creates new or updates existing production lot.

**Process**:
1. Validate input: qty, qty_unit, base_schedule_date, forecast_schedule_date
2. Create `work_order_lot` record with id_wo reference
3. Generate or update `work_order_schedule` records for each schedule type (production, inspection, coating, etc.)
4. Set initial progress values if creating new lot (qty_real = 0, percent_real = 0)
5. Return success response

### 5.4.5.3.2 Delete Lot

`WorkOrderController::deleteLot()` - Removes lot and associated schedules if no progress made yet.

**Process**:
1. Find lot by ID
2. Delete associated `work_order_schedule` records
3. Delete `work_order_lot` record
4. Recalculate work order total progress
5. Return success response

## 5.4.5.4 Database

**Project Database** (`mongodb_project_{project_code}`):

- **`work_order_lot`** - Lot records: id_wo, qty, qty_unit, base_schedule_date, forecast_schedule_date, created_at
- **`work_order_schedule`** - Schedule per lot: id_wo_lot, schedule (production/inspection/coating/etc.), qty, qty_real, percent_real, base/forecast/actual dates, status
- **`work_order`** - Referenced by lots for total quantity validation

---

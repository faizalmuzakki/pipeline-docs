# 5.3.3 Work Order Progress Tracking

This component handles the calculation and monitoring of work order progress based on production data from Length History tracking. It provides real-time progress percentage calculation, status updates, and integration with the overall project progress tracking system.

---

## Component Design Diagram

```mermaid
graph TB
    subgraph Trigger["Trigger Events"]
        A[Length History<br/>Submitted]
        B[Work Order<br/>Status Change]
    end
    
    subgraph ApplicationServices["Application Services"]
        C[Length History Service]
        D[Work Order Service]
        E[Progress Chart Service]
        F[Overall Progress Service]
    end
    
    subgraph Database["Database Layer"]
        G[(Project DB:<br/>mongodb_project_X)]
    end
    
    A -->|New length record| C
    C -.Get all length records for WO.-> G
    C -.Calculate total length produced.-> C
    C -.Call updateWOProgress().-> D
    D -.Get WO qty_m from SOW.-> G
    D -.Calculate progress %:<br/>(total_length / wo_qty_m) × 100.-> D
    D -.Update work_order.progress.-> G
    D -.Check if progress >= 100%.-> D
    D -.Update status to "Completed".-> G
    D -.Trigger progress chart regen.-> E
    E -.Update project progress charts.-> G
    E -.Call overall progress update.-> F
    F -.Aggregate all WO progress.-> G
    F -.Update overall_work_order.-> G
    
    B -->|Manual status update| D
    D -.Validate status transition.-> D
    D -.Update work_order.status.-> G
    D -.Trigger progress recalc.-> E
    
    style Trigger fill:#ffebee
    style ApplicationServices fill:#f3e5f5
    style Database fill:#e8f5e9
```

*Figure: Work Order Progress Tracking Component Design*

---

## 5.3.3.1 User Interface

### 5.3.3.1.1 Work Order List with Progress

The Work Order List displays progress information for each work order, showing progress percentage, status, and visual progress bars. Users can view real-time progress updates as length history records are submitted. The progress column shows percentage (e.g., "75%") with color coding: red (<50%), yellow (50-99%), green (100%). No direct user input is required - progress is automatically calculated from length history data.

### 5.3.3.1.2 Work Order Detail with Progress Timeline

The Work Order Detail page displays comprehensive progress information including current progress percentage, total length produced vs target quantity, production timeline showing length history submissions over time, and status history (New → In Progress → Completed). Users can view detailed breakdown of progress by date, showing cumulative progress growth over the production period.

### 5.3.3.1.3 Progress Dashboard

The Progress Dashboard provides project-wide progress visualization showing all work orders with their progress percentages, overall project progress (weighted average of all WOs), progress trends over time with S-curve charts, and work orders grouped by status (New, In Progress, Completed). This gives project managers a high-level view of production progress across all vendors.

---

## 5.3.3.2 Security

Progress tracking operates as a background calculation process with no direct user input. Security is inherited from the Length History submission process (5.3.2), which requires `PROJECT_CONTROL:RW` privilege. Progress viewing is controlled by work order access privileges: `PROJECT_CONTROL:R` for read-only users and `PROJECT_CONTROL:RW` for authorized users. Vendors can only view progress for their assigned work orders (filtered by `id_manufacturer`).

---

## 5.3.3.3 Application Services

### 5.3.3.3.1 Progress Calculation (Automatic)

**Triggered by**: Length History submission (automatic)

**Process** (`WorkOrderService::updateWOProgress()` called by `LengthHistoryService::submitLengthReport()`):

1. **Retrieve All Length History Records**: Queries `length_history` collection for all records with matching `id_wo`.

2. **Calculate Total Length Produced**: Sums all `length` values from length history records.
   ```
   total_length_produced = SUM(length_history.length WHERE id_wo = {work_order_id})
   ```

3. **Retrieve Work Order Target Quantity**: Gets `qty_m` (quantity in meters) from work order record.

4. **Calculate Progress Percentage**:
   ```
   progress_percentage = (total_length_produced / qty_m) × 100
   ```

5. **Update Work Order Progress**: Updates `work_order.progress` field with calculated percentage.

6. **Check for Completion**: If `progress_percentage >= 100%`, automatically updates `work_order.status` to "Completed".

7. **Trigger Progress Chart Regeneration**: Calls Progress Chart Service to update project-wide progress charts.

### 5.3.3.3.2 Progress Chart Regeneration

**Process** (`ProgressChartService::regenerateProgressCharts()` called by `WorkOrderService::updateWOProgress()`):

1. **Aggregate Work Order Progress**: Retrieves all work orders for the project with their progress percentages.

2. **Calculate Overall Progress**: Computes weighted average of all work order progress based on quantities:
   ```
   overall_progress = SUM(wo.progress × wo.qty_m) / SUM(wo.qty_m)
   ```

3. **Generate Progress Timeline**: Creates time-series data showing progress over time by grouping length history submissions by date.

4. **Update Progress Charts**: Stores progress data in `overall_work_order` collection for visualization:
   - S-curve chart data (schedule vs actual)
   - Progress by vendor
   - Progress by item type
   - Cumulative progress over time

5. **Trigger Artisan Command**: Executes `progress:chart` Artisan command to regenerate project-wide progress visualizations.

### 5.3.3.3.3 Work Order Status Management

**Process** (`WorkOrderService::updateStatus()`):

**Status Transitions**:
- **New → In Progress**: Manually set when production starts, or automatically set when first length history record is submitted
- **In Progress → Completed**: Automatically set when progress >= 100%, or manually set by authorized users
- **Any Status → Cancelled**: Manually set by authorized users (requires confirmation)

**Validation Rules**:
- Cannot change status from "Completed" to "In Progress" without authorization
- Cannot change status to "Completed" if progress < 100% (unless override permission)
- Status changes trigger progress recalculation and chart regeneration

### 5.3.3.3.4 Overall Progress Service Integration

**Process** (`OverallProgressService::updateOverallProgress()`):

Aggregates work order progress into project-level progress metrics:

- **By SOW**: Groups work orders by parent SOW and calculates SOW completion percentage
- **By Vendor**: Groups work orders by manufacturer and calculates vendor performance metrics
- **By Item Type**: Groups work orders by item type (linepipe, elbow, flange, etc.) and calculates type-specific progress
- **Project Overall**: Calculates total project progress as weighted average of all SOWs

Stores aggregated data in `overall_work_order` collection for dashboard visualization and reporting.

### 5.3.3.3.5 Progress Data Retrieval

**Process** (`WorkOrderService::getProgressData()`):

Retrieves comprehensive progress data for work order display:

- **Current Progress**: Latest progress percentage from `work_order.progress`
- **Production History**: Timeline of length history submissions with cumulative totals
- **Progress Trend**: Daily/weekly progress growth rate
- **Estimated Completion**: Projected completion date based on current production rate
- **Status History**: Timeline of status changes (New → In Progress → Completed)

Returns formatted data for UI display in work order list, detail pages, and progress dashboards.

---

## 5.3.3.4 Database

MongoDB serves as the central data store for Work Order Progress Tracking. The component interacts with the following collections:

**Project Database (`mongodb_project_{project_code}`):**

- **`work_order`** - Work order records with progress tracking. Key fields: _id, id_sow (reference to parent SOW), qty_m (target quantity in meters from SOW), progress (decimal, percentage calculated from length history: 0.00 to 100.00), status ("New", "In Progress", "Completed", "Cancelled"), status_history (array of status changes with timestamps), updated_at (timestamp of last progress update).

- **`length_history`** - Source data for progress calculation. Key fields: _id, id_wo (reference to work_order._id), length (decimal, in meters), created_at (timestamp). Progress is calculated by summing all length values for a work order.

- **`overall_work_order`** - Aggregated progress data for project-wide visualization. Key fields: _id, project_code, overall_progress (weighted average of all WO progress), progress_by_vendor (object with vendor_id keys and progress values), progress_by_item_type (object with item type keys and progress values), progress_timeline (array of date/progress pairs for S-curve charts), last_updated (timestamp).

All progress calculations and updates are handled through the Work Order Service and Progress Chart Service, ensuring consistent data access patterns and proper multi-tenant database routing.

---

## Integration Points

### Upstream Integration
- **Length History Tracking (5.3.2)**: Provides source data (individual pipe lengths) for progress calculation
- **Work Order Generation (5.3.1)**: Creates work orders with target quantities (qty_m) used as progress denominator

### Downstream Integration
- **Overall Progress Tracking (5.11)**: Aggregates WO progress into project-level progress metrics
- **Progress Dashboard**: Displays progress visualizations (S-curves, progress by vendor, progress by item type)
- **SOW Progress**: Work order progress rolls up to parent SOW progress calculation

### Lateral Integration
- **Progress Chart Service**: Generates time-series progress data for visualization
- **Artisan Commands**: `progress:chart` command regenerates project-wide progress charts
- **Status Management**: Progress percentage influences automatic status transitions

---

## Business Rules

1. **Automatic Calculation**: Progress is automatically calculated when length history is submitted (no manual input)
2. **Progress Formula**: `(total_length_produced / wo_qty_m) × 100`
3. **Automatic Completion**: If progress >= 100%, work order status automatically updated to "Completed"
4. **Status Transitions**: 
   - New → In Progress: Auto-set on first length history submission
   - In Progress → Completed: Auto-set when progress >= 100%
   - Manual overrides require authorization
5. **Progress Chart Regeneration**: Every progress update triggers project-wide chart regeneration
6. **Weighted Average**: Overall project progress calculated as weighted average based on work order quantities
7. **Real-Time Updates**: Progress updates are reflected immediately in UI (no batch processing)
8. **Vendor Filtering**: Vendors can only view progress for their assigned work orders
9. **Progress Persistence**: Progress percentage stored in `work_order.progress` field for quick retrieval
10. **Status History**: All status changes logged with timestamps for audit trail

---

## Progress Calculation Flow

```
Length History Submitted
  ↓
Sum All Lengths for Work Order
  ↓
Calculate Progress %
  progress = (total_length / wo_qty_m) × 100
  ↓
Update work_order.progress
  ↓
Check if progress >= 100%
  ↓ Yes
Auto-Update status to "Completed"
  ↓
Trigger Progress Chart Regeneration
  ↓
Update overall_work_order Collection
  ↓
Aggregate to Project-Level Progress
  ↓
Update SOW Progress
```

---

## Access Control

**PROJECT_CONTROL Privilege** (Progress Viewing):
- **RW**: Super Admin, Project Manager, Project Team (all variants), MI Team - Can view all WO progress, manually override status
- **R**: Customer, Non MI Team, Global Viewer - Can view all WO progress (read-only)
- **R (Filtered)**: Vendors - Can only view progress for their assigned work orders

**Note**: Progress calculation is automatic and requires no direct user permission. Security is inherited from Length History submission (5.3.2).

---

## Related Sections

- **[7.9 Work Order Management DFD](../../07-Data-Flow-Diagrams.md#79-work-order-management)** - Shows progress tracking integration
- **[5.3.1 Work Order Generation](5.3.1-Work-Order-Generation-Vendor-Tabs.md)** - Upstream: WO creation sets target quantities
- **[5.3.2 Length History Tracking](5.3.2-Length-History-Tracking.md)** - Upstream: Provides source data for progress calculation
- **[5.11 Progress Tracking](../5.11-Progress-Module.md)** - Downstream: Aggregates WO progress into project progress
- **[7.6 Progress Tracking DFD](../../07-Data-Flow-Diagrams.md#76-progress-tracking)** - Shows overall progress tracking flow

# 5.5.2 Cargo Details Page

## 5.5.2.1 Overview

The Cargo Details page displays detailed information about a specific cargo including transfer routes, tally operations, and load/unload tracking. The page adapts its layout based on whether the cargo is a customer pickup or standard transfer.

```mermaid
graph LR
    UI["&lt;&lt;UI&gt;&gt;<br/>Cargo Details"]
    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]

    TRANS_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>TransferService"]
    TRANS_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>TransferService"]
    TALLY_SVC["&lt;&lt;Application Service&gt;&gt;<br/>TallyListService"]

    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]

    UI -->|Send Token| SEC1
    SEC1 -.->|Get cargo details| TRANS_SVC1
    TRANS_SVC1 -.->|Query cargo & routes| DB1

    UI -.->|Event complete tally| SEC2
    SEC2 -.->|Validate & complete| TRANS_SVC2
    TRANS_SVC2 -.->|Update tally status| DB2

    UI -.->|Event upload tally| SEC3
    SEC3 -.->|Check WO progress| TALLY_SVC
    TALLY_SVC -.->|Validate progress| DB3

    style UI fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style TRANS_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TRANS_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style TALLY_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
```

## 5.5.2.2 User Interface

The Cargo Details page displays cargo information in a header section showing item description, specification, coating type and spec (if applicable), quantity with unit, related SOW, and customer pickup indicator. Below the header, the page shows route information in a table-like format. For standard transfers, it displays Load Out and Load In columns with port names, ETD/ETA dates, vessel information, tally file dropdowns, "Tally Completed" buttons (when not completed), and "View Tally" buttons to see tally details. For customer pickup transfers, it displays only Load Out information with simplified columns. Users can upload tally sheets for each route leg, mark tally as completed when all items are tallied, view detailed tally information including pipe details, download tally attachments, and track completion status per route.

## 5.5.2.3 Security

Middleware validates the authentication token sent from the Cargo Details UI. Only authenticated and authorized users can proceed to view and manage cargo details.

**Security Checks:**
- `auth:api` - Validates JWT token via Laravel Passport
- `project.session:api` - Validates user has access to the project database
- `user.privileges:project.transfer,R` - Read permission to view cargo details
- `user.privileges:project.transfer,W` - Write permission to manage tally operations

## 5.5.2.4 Application Services

### 5.5.2.4.1 Get Cargo Details

**TransferService**: Retrieves detailed cargo information including cargo ID, item description and type, specification details, coating information (if applicable), quantity and unit, related SOW information, customer pickup flag, route information with load out/in details, tally files per route, completion status per route, and vessel information. Returns cargo data with all associated route and tally information.

### 5.5.2.4.2 Check Work Order Progress

**TallyListService**: Validates if work order progress is sufficient to allow tally upload for load out operations. Checks if work order has completed items ready for transfer. Returns validation status and error message if not ready.

### 5.5.2.4.3 Check Complete Tally Quantity

**TransferService**: Validates if all required items have been tallied before marking as complete. Compares tallied quantity against expected cargo quantity. Returns validation status and any discrepancies.

### 5.5.2.4.4 Complete Tally

**TransferService**: Marks a route's tally as completed after validation. Updates route completion status, sets completion timestamp, locks tally from further edits, and updates transfer overall status if all routes complete. Returns success status.

## 5.5.2.5 Database

Cargo and tally data is stored and retrieved from MongoDB:

**Project Database:**
• **cargo** - Cargo records with item details and quantities
• **transfer** - Transfer records for cargo relationships
• **route** - Route records for load out/in information
• **tally_file** - Tally sheet uploads and metadata
• **work_order** - Work order records for progress validation
• **sow** - SOW records for cargo relationships

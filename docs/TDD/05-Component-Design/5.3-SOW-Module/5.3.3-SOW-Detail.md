# 5.3.3 SOW Detail

The SOW Detail page is used to view and manage the full lifecycle of a SOW. Users can view comprehensive SOW information, create delivery lots, and submit the SOW to trigger work order generation.

```mermaid
graph LR
    UI_DETAIL["&lt;&lt;UI&gt;&gt;<br/>SOW Detail"]
    SEC1["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC2["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    SEC3["&lt;&lt;Security&gt;&gt;<br/>Middleware"]
    
    SOW_SVC1["&lt;&lt;Application Service&gt;&gt;<br/>SOWService"]
    ADDR_SVC["&lt;&lt;Application Service&gt;&gt;<br/>AddressService"]
    LOT_CREATE["&lt;&lt;Application Service&gt;&gt;<br/>Delivery Lots Created"]
    SOW_SVC2["&lt;&lt;Application Service&gt;&gt;<br/>SOWService"]
    SOW_SUBMIT["&lt;&lt;Application Service&gt;&gt;<br/>SOW Submitted"]
    SOW_SVC3["&lt;&lt;Application Service&gt;&gt;<br/>SOWService"]
    WO_SVC["&lt;&lt;Application Service&gt;&gt;<br/>WorkOrderService"]
    PC_SVC["&lt;&lt;Application Service&gt;&gt;<br/>ProjectControlService"]
    
    DB1[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB2[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB3[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB4[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]
    DB5[("&lt;&lt;Database&gt;&gt;<br/>MongoDB")]

    %% Initial Data Load Flow
    UI_DETAIL -->|Send Token| SEC1
    SEC1 -.->|Get SOW detail,<br/>work orders, inspection| SOW_SVC1
    SOW_SVC1 -.->|Query data| DB1

    %% Create Delivery Lots Flow
    UI_DETAIL -.->|Event create lots| SEC2
    SEC2 -.->|Get delivery addresses| ADDR_SVC
    ADDR_SVC -.->|Get addresses from DB| DB2
    SEC2 -.->|Validate & create lots| LOT_CREATE
    LOT_CREATE -.->|Save lots| SOW_SVC2
    SOW_SVC2 -.->|Save lots to DB| DB3

    %% Submit SOW Flow
    UI_DETAIL -.->|"Event submit SOW<br/>(when lots qty = SOW qty)"| SEC3
    SEC3 -.->|Validate & submit| SOW_SUBMIT
    SOW_SUBMIT -.->|Update status to Completed| SOW_SVC3
    SOW_SVC3 -.->|Update DB| DB4
    SOW_SUBMIT -.->|Generate work orders| WO_SVC
    WO_SVC -.->|Create WOs| DB4
    SOW_SUBMIT -.->|Recalculate weight & forecast| PC_SVC
    PC_SVC -.->|Update project control| DB5

    style UI_DETAIL fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC1 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC2 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SEC3 fill:#2C5F7C,stroke:#1a3a4a,color:#fff
    style SOW_SVC1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style SOW_SVC2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style SOW_SVC3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style ADDR_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style LOT_CREATE fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style SOW_SUBMIT fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style WO_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style PC_SVC fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB1 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB2 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB3 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB4 fill:#4FB3BF,stroke:#2a6d76,color:#fff
    style DB5 fill:#4FB3BF,stroke:#2a6d76,color:#fff
```

## 5.3.3.1 User Interface

This UI displays the complete details of a selected SOW item. It shows comprehensive SOW information including item details, specifications, manufacturers, quantities, pricing, work orders, inspection results, progress tracking, and delivery lots. Users can create delivery lots by defining specific delivery addresses, quantities, and required dates. Once the total delivery lots quantity matches the SOW quantity, the Submit button becomes visible. Submitting the SOW changes its status to Completed and triggers work order generation. Each action passes through security and calls specific application services to update the SOW record.

## 5.3.3.2 Security
Middleware validates the authentication token sent from the SOW Detail UI. Only authenticated and authorized users can proceed to view or manage SOW actions.

## 5.3.3.3 Application Services

### 5.3.3.3.1 Initial Data Retrieval
• **SOWService**: Retrieves comprehensive SOW detail including item details, specifications, manufacturers, quantities, pricing, status, progress data, coating information, and delivery lots.
• **SOWService**: Retrieves work order data including total count, manufacturing work orders, and coating work orders.
• **SOWService**: Retrieves inspection results and status per SOW item and pipe type.
• **DataListService**: Fetches delivery address options from project configuration or customer data.

### 5.3.3.3.2 Delivery Lots Created
Creates multiple delivery lots from a SOW with specific delivery addresses, quantities, and required dates. Validates total lots quantity doesn't exceed SOW quantity. Creates records in sow_lot collection with reference to parent SOW, lot-specific quantities, delivery addresses, and required dates. Calculates quantity conversions for each lot and updates required_for_submit_qty flag.

### 5.3.3.3.3 SOW Submitted
Changes status from "Draft" to "Completed" and triggers work order generation. Only available when total delivery lots quantity matches SOW quantity. Validates all specifications are complete and form status is "Complete". Triggers work order generation for manufacturing and coating, project control weight calculation, forecast generation, and progress chart updates. Returns success status and total project value.

## 5.3.3.4 Database

SOW detail data is retrieved and updated in MongoDB across several collections:
• **sow** - Main SOW record with all details
• **sow_lot** - Delivery lots with delivery addresses and dates
• **sow_coating** - Coating records
• **work_order** - Work orders generated from submitted SOW
• **inspection** - Inspection results and status
• **project_control_sow_list** - SOW weight and control data
• **progress_work_order_chart** - Progress tracking data
